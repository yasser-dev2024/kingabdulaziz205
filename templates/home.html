{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>إحالاتي</title>
  <style>
    :root{
      --brand:#1f3c88; --brand2:#2ebfa5; --accent:#ffb703;
      --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --glass1: rgba(255,255,255,.22);
      --glass2: rgba(255,255,255,.10);
      --bg0:#ffffff; --bg1:#fbfdff; --bg2:#f7fbff;
      --chip:#f1f5f9; --surface:#ffffff; --surface2:#f8fafc;
      --holiday:#e11d48; --today:#1d4ed8;
      --grad1:#4f46e5; --grad2:#06b6d4;
      --gA:#2563eb; --gB:#06b6d4;   /* Gregorian gradient */
      --hA:#16a34a; --hB:#06b6d4;   /* Hijri gradient */
      --shadow: 0 10px 30px rgba(2,6,23,.08);
    }

    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Tajawal,Arial;
      background:
        radial-gradient(1100px 560px at 85% -15%, rgba(59,130,246,.10), transparent 60%),
        radial-gradient(950px 600px at -10% 110%, rgba(45,212,191,.12), transparent 60%),
        repeating-linear-gradient(45deg, rgba(15,23,42,.035) 0 1px, transparent 1px 28px),
        repeating-linear-gradient(-45deg, rgba(15,23,42,.028) 0 1px, transparent 1px 28px),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);
      background-attachment: fixed,fixed,fixed,fixed,fixed;
      min-height:100dvh;
    }

    .wrap{max-width:1100px;margin:auto;padding:22px 16px}

    /* ====== الشريط الإخباري ====== */
    .ticker-shell{
      position:relative; border-radius:18px; overflow:hidden;
      background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.04));
      border:1px solid var(--glass1);
      box-shadow: var(--shadow), inset 0 1px 0 rgba(34, 3, 236, 0.35);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .ticker-track{
      display:flex; gap:40px; padding:12px 16px; white-space:nowrap;
      animation: ticker 22s linear infinite;
      font-weight:700; letter-spacing:.2px; color:#0b1220;
    }
    .ticker-chip{padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--line); color:var(--text); font-size:13px}
    @keyframes ticker{from{transform:translateX(0)}to{transform:translateX(-50%)}}

    /* ====== شريط الأزرار + بطاقات التاريخ المصغّرة ====== */
    .actions-bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; flex-wrap:wrap;
    }

    /* أزرار اللوحات */
    .top-actions{display:flex; gap:12px; align-items:center}
    .drop{position:relative}
    .btn-pill{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
      border-radius:999px; cursor:pointer; user-select:none; color:#fff;
      background:linear-gradient(90deg,var(--grad2),var(--grad1));
      box-shadow:0 10px 20px rgba(31,60,136,.20);
      border:1px solid rgba(255,255,255,.35); font-weight:800;
    }
    .btn-pill svg{vertical-align:-3px}
    .panel{
      position:absolute; right:0; top:100%; transform:translateY(12px);
      width:min(96vw, 820px);
      border-radius:16px; overflow:hidden; background:#fff; border:1px solid var(--line);
      box-shadow:0 24px 60px rgba(2,6,23,.20);
      opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; z-index:30;
    }
    .drop:hover .panel, .drop:focus-within .panel{opacity:1; pointer-events:auto; transform:translateY(8px)}
    .panel-head{
      padding:12px 16px; font-weight:800; color:#1f2937;
      background:linear-gradient(90deg,#eef2ff,#f8fafc); border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
    }
    .panel-body{max-height:440px; overflow:auto}

    /* بطاقات التاريخ المصغّرة */
    .mini-dates{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .mini-date{
      position:relative; display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:16px;
      background:rgba(255,255,255,.85); border:1px solid rgba(15,23,42,.08);
      box-shadow:0 8px 18px rgba(2,6,23,.06); backdrop-filter: blur(8px);
      animation: pulse 3s ease-in-out infinite;
    }
    .mini-date::after{
      content:""; position:absolute; inset:-1.5px; border-radius:17px; z-index:0; opacity:.75;
      background:conic-gradient(from 0deg, var(--gA), var(--gB), #a78bfa, var(--gA));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; padding:1.5px;
    }
    .mini-date.h::after{background:conic-gradient(from 0deg, var(--hA), var(--hB), #4f46e5, var(--hA))}
    @keyframes pulse{
      0%,100%{box-shadow:0 8px 18px rgba(2,6,23,.06)}
      50%{box-shadow:0 8px 26px rgba(6,182,212,.18)}
    }

    .badge{
      position:relative; z-index:1;
      width:36px; height:36px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900;
      box-shadow:0 6px 14px rgba(79,70,229,.18)
    }
    .badge.g{background:linear-gradient(135deg,var(--gA),var(--gB))}
    .badge.h{background:linear-gradient(135deg,var(--hA),var(--hB))}

    .num{
      position:relative; z-index:1;
      font-size:28px; line-height:1; font-weight:1000; min-width:34px; text-align:center;
      background:linear-gradient(90deg,var(--gA),var(--gB)); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .mini-date.h .num{background:linear-gradient(90deg,var(--hA),var(--hB)); -webkit-background-clip:text; color:transparent}

    .meta{position:relative; z-index:1; display:flex; flex-direction:column; line-height:1.2}
    .meta .line1{font-weight:900; font-size:13.5px}
    .meta .line2{font-size:11.5px; color:var(--muted); font-variant-numeric:tabular-nums}

    /* ====== جدول المواعيد داخل اللوحة ====== */
    .imp-table{width:100%; border-collapse:separate; border-spacing:0}
    .imp-table thead th{
      position:sticky; top:0; background:#f8fafc; z-index:1;
      padding:12px; font-weight:900; color:#334155; border-bottom:1px solid var(--line); text-align:center;
    }
    .imp-table tbody td{padding:12px; border-bottom:1px solid #eef2f7; text-align:center; font-size:14px}
    .imp-table tbody tr:nth-child(even) td{background:#fbfdff}
    .imp-table tbody tr:hover td{background:#f1f8ff}
    .row-type{width:4px}
    .type-start{background:#16a34a} .type-flag{background:#2563eb}
    .type-break{background:#d97706} .type-off{background:#dc2626}
    .g-date{font-weight:800;color:#0f172a; font-variant-numeric:tabular-nums}
    .h-date{font-weight:800;color:#1d4ed8; font-variant-numeric:tabular-nums}
    .type-badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; color:#fff; font-weight:900; font-size:12px}
    .t-off{background:#dc2626} .t-break{background:#d97706} .t-flag{background:#2563eb} .t-start{background:#16a34a}

    /* ====== التقويم داخل اللوحة ====== */
    .cal{background:var(--surface); border-top:1px solid var(--line)}
    .cal-head{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px}
    .cal-title{margin:0; font-size:16px}
    .cal-nav{display:flex; gap:8px}
    .btn{appearance:none; border:1px solid var(--line); color:#fff; background:linear-gradient(90deg,var(--grad1),var(--grad2)); border-radius:12px; padding:8px 12px; font-weight:700; cursor:pointer; box-shadow:0 8px 18px rgba(6,182,212,.18)}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr)}
    .cal-dow, .cal-day{padding:10px 8px; text-align:center; border-bottom:1px solid #dbeafe}
    .cal-dow{background:linear-gradient(90deg,#eef2ff,#f8fafc); font-weight:800; color:#475569}
    .cal-day{min-height:64px; position:relative; background:#fff}
    .cal-day .g{font-weight:700}
    .cal-day .h{font-size:11px; color:var(--muted)}
    .cal-day.today{outline:2px solid var(--today); outline-offset:-2px; border-radius:6px}
    .cal-day.holiday{background:linear-gradient(180deg, rgba(225,29,72,.10), rgba(225,29,72,.04))}
    .cal-day .tag{position:absolute; inset:auto 6px 6px auto; font-size:10px; background:#fff; border:1px solid var(--line); border-radius:999px; padding:2px 6px}

    .legend{display:flex; gap:10px; flex-wrap:wrap; padding:10px 14px}
    .legend .lg{display:flex; align-items:center; gap:6px; font-size:12px; color:#64748b}
    .legend .dot{width:10px; height:10px; border-radius:3px}
    .dot-holiday{background:rgba(225,29,72,.6)}
    .dot-today{background:rgba(29,78,216,.7)}

    .cal-wrap-original[hidden]{display:none !important}
  </style>
</head>
<body>
  {% include 'header.html' %}
تصميم وبرمجة / ياسر الزمزمي
  <div class="wrap">
    {% with t=news_ticker.text|default:"مرحبًا بكم في نظام الإحالات — يمكن للإدارة تحديث هذا الشريط من لوحة التحكم." %}
    <section class="ticker-shell" aria-label="الشريط الإخباري">
      <div class="ticker-track">
        <span class="ticker-chip">تنبيه</span><span>{{ t }}</span>
        <span class="ticker-chip">تنبيه</span><span>{{ t }}</span>
      </div>
    </section>
    {% endwith %}

    <!-- الأزرار + بطاقات التاريخ المصغّرة -->
    <div class="actions-bar">
      <div class="top-actions">
        <!-- مواعيد هامة -->
        <div class="drop">
          <button class="btn-pill" type="button" aria-haspopup="true" aria-label="مواعيد هامة (مرّر أو اضغط)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M13 16h-2v-4h2m0 8h-2v-2h2M1 21h22L12 2 1 21Z"/></svg>
            مواعيد هامة
          </button>
          <div class="panel" role="dialog" aria-label="قائمة المواعيد">
            <div class="panel-head">
              <span>مواعيد العام (ميلادي / هجري)</span>
              <span style="font-size:12px;color:#64748b">للإغلاق حرّك المؤشر للخارج</span>
            </div>
            <div class="panel-body">
              <table class="imp-table" id="imp-table">
                <thead>
                  <tr>
                    <th style="width:6px"></th>
                    <th>الحدث</th>
                    <th>التاريخ الميلادي</th>
                    <th>التاريخ الهجري</th>
                    <th>النوع</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- التقويم -->
        <div class="drop">
          <button class="btn-pill" type="button" aria-haspopup="true" aria-label="التقويم (مرّر أو اضغط)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 11h10v2H7v-2Zm-2 8h14V7H5v12Zm2-16h2V1h2v2h4V1h2v2h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2Z"/></svg>
            التقويم
          </button>
          <div class="panel" role="dialog" aria-label="لوحة التقويم">
            <div class="panel-head">
              <span id="calp-title" class="cal-title">التقويم</span>
              <div class="cal-nav">
                <button id="calp-prev" class="btn" type="button">◀ الشهر السابق</button>
                <button id="calp-today" class="btn" type="button">اليوم</button>
                <button id="calp-next" class="btn" type="button">الشهر التالي ▶</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="cal">
                <div class="cal-grid" id="calp-dow"></div>
                <div class="cal-grid" id="calp-days"></div>
              </div>
              <div class="legend">
                <div class="lg"><span class="dot dot-today"></span> اليوم</div>
                <div class="lg"><span class="dot dot-holiday"></span> إجازة/مناسبة سعودية</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- بطاقات التاريخ المصغّرة -->
      <div class="mini-dates">
        <!-- Gregorian -->
        <div class="mini-date g" aria-live="polite" aria-label="التاريخ الميلادي">
          <div class="badge g">AD</div>
          <div class="num" id="g-mini-big">—</div>
          <div class="meta">
            <div class="line1" id="g-line1">—</div>
            <div class="line2" id="g-line2">—</div>
          </div>
        </div>

        <!-- Hijri -->
        <div class="mini-date h" aria-live="polite" aria-label="التاريخ الهجري">
          <div class="badge h">AH</div>
          <div class="num" id="h-mini-big">—</div>
          <div class="meta">
            <div class="line1" id="h-line1">—</div>
            <div class="line2" id="h-line2">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- التقويم الأصلي (مخفي للحفاظ على البنية) -->
    <section class="cal-wrap-original" aria-label="التقويم" hidden>
      <div class="cal">
        <div class="cal-grid"></div>
        <div class="cal-grid"></div>
      </div>
    </section>
  </div>

  {% include 'footer.html' %}

  <script>
    // ======= أدوات مساعدة =======
    const pad2 = v => (v<10? '0'+v : ''+v);

    // ======= بطاقات التاريخ (بالصيغ المطلوبة) =======
    (function setMiniDates(){
      const now = new Date();

      /* === Gregorian (إجبار استخدام التقويم الميلادي) === */
      const gDayNum   = now.getDate();
      const gMonthNum = now.getMonth()+1;
      const gYear     = now.getFullYear();

      // نستخدم ar-EG (تقويم ميلادي) أو ar-SA-u-ca-gregory لضمان "أغسطس" وليس "صفر"
      let gMonthName = new Intl.DateTimeFormat('ar-EG', {month:'long'}).format(now);
      // احتياط إضافي لو كان المتصفح يُعيد أسماء هجري:
      const hijriNames = ['محرم','صفر','ربيع','جمادى','رجب','شعبان','رمضان','شوال','ذو القعدة','ذو الحجة'];
      if (hijriNames.some(n => gMonthName.includes(n))) {
        gMonthName = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', {month:'long'}).format(now);
      }

      const gLine1 = `${gDayNum} ${gMonthName} ${gYear}`;            // 17 اغسطس 2025
      const gLine2 = `${gYear}/${pad2(gMonthNum)}/${pad2(gDayNum)}`; // 2025/08/17

      document.getElementById('g-mini-big').textContent = gDayNum;
      document.getElementById('g-line1').textContent    = gLine1;
      document.getElementById('g-line2').textContent    = gLine2;

      /* === Hijri === */
      const hParts = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {weekday:'long', year:'numeric', month:'numeric', day:'numeric'}).formatToParts(now);
      const hp = Object.fromEntries(hParts.map(p=>[p.type,p.value]));
      const hYear = +hp.year, hMonth = +hp.month, hDay = +hp.day;

      const hWeekName  = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {weekday:'long'}).format(now); // الأحد
      const hMonthName = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {month:'long'}).format(now);   // صفر

      const hLine1 = `${hWeekName} ${hDay}${hMonthName} ${hYear}`; // الاحد 23صفر 1447
      const hLine2 = `${hYear}/${hMonth}/${hDay}`;                 // 1447/2/23
      const hBig   = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {day:'numeric'}).format(now);

      document.getElementById('h-mini-big').textContent = hBig;
      document.getElementById('h-line1').textContent    = hLine1;
      document.getElementById('h-line2').textContent    = hLine2;
    })();

    // ======= جدول "مواعيد هامة" =======
    (function importantDates(){
      const rows = [
        {g:'17/08/2025', h:'23/02/1447', t:'عودة المعلمين الممارسين للتدريس', type:'start'},
        {g:'24/08/2025', h:'01/03/1447', t:'بداية الدراسة للعام الدراسي 1447-1448', type:'start'},
        {g:'23/09/2025', h:'01/04/1447', t:'اليوم الوطني', type:'flag'},
        {g:'12/10/2025', h:'20/04/1447', t:'إجازة إضافية', type:'break'},
        {g:'21/11/2025', h:'30/05/1447', t:'إجازة الخريف', type:'break'},
        {g:'11/12/2025', h:'20/06/1447', t:'إجازة إضافية', type:'break'},
        {g:'09/01/2026', h:'20/07/1447', t:'إجازة منتصف العام الدراسي', type:'break'},
        {g:'22/02/2026', h:'05/09/1447', t:'يوم التأسيس', type:'flag'},
        {g:'06/03/2026', h:'17/09/1447', t:'عيد الفطر', type:'off'},
        {g:'11/03/2026', h:'22/09/1447', t:'يوم العلم السعودي', type:'flag'},
        {g:'22/05/2026', h:'05/12/1447', t:'عيد الأضحى', type:'off'},
      ];
      const tbody = document.querySelector('#imp-table tbody');
      tbody.innerHTML = '';
      const label = t => ({off:'تعطيل', break:'إجازة', flag:'مناسبة', start:'بداية'}[t] || 'موعد');
      const badgeClass = t => ({off:'t-off', break:'t-break', flag:'t-flag', start:'t-start'}[t] || 't-start');
      const sideClass  = t => ({off:'type-off', break:'type-break', flag:'type-flag', start:'type-start'}[t] || 'type-start');
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="row-type ${sideClass(r.type)}"></td>
          <td style="text-align:start;font-weight:800;color:#0f172a">${r.t}</td>
          <td class="g-date">${r.g}</td>
          <td class="h-date">${r.h}</td>
          <td><span class="type-badge ${badgeClass(r.type)}">${label(r.type)}</span></td>
        `;
        tbody.appendChild(tr);
      });
    })();

    // ======= التقويم داخل اللوحة =======
    function setupCalendar(ids){
      const gridDow  = document.getElementById(ids.dow);
      const gridDays = document.getElementById(ids.days);
      const titleEl  = document.getElementById(ids.title);
      const btnPrev  = document.getElementById(ids.prev);
      const btnNext  = document.getElementById(ids.next);
      const btnToday = document.getElementById(ids.today);

      const dow = ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
      gridDow.innerHTML = '';
      dow.forEach(d => { const el = document.createElement('div'); el.className = 'cal-dow'; el.textContent = d; gridDow.appendChild(el); });

      let view = new Date();

      const hPair = (d) => {
        const parts = new Intl.DateTimeFormat('en-TN-u-ca-islamic', {month:'numeric', day:'numeric'}).formatToParts(d);
        const m = +parts.find(p=>p.type==='month').value;
        const day = +parts.find(p=>p.type==='day').value;
        return [m, day];
      };

      function isSaudiHoliday(date){
        const m = date.getMonth()+1, d = date.getDate();
        if (m===2 && d===22) return 'يوم التأسيس';
        if (m===9 && d===23) return 'اليوم الوطني';
        const [hm, hd] = hPair(date);
        if (hm===10 && hd>=1 && hd<=4) return 'عيد الفطر';
        if (hm===12 && hd===9) return 'يوم عرفة';
        if (hm===12 && hd>=10 && hd<=13) return 'عيد الأضحى';
        return null;
      }

      const monthTitle = (d) => new Intl.DateTimeFormat('ar-SA', {month:'long', year:'numeric'}).format(d);

      function render(){
        titleEl.textContent = 'التقويم – ' + monthTitle(view);
        gridDays.innerHTML = '';
        const y = view.getFullYear(), m = view.getMonth();
        const first = new Date(y, m, 1);
        const startIdx = first.getDay();
        const daysInMonth = new Date(y, m+1, 0).getDate();

        for (let i=0;i<startIdx;i++){
          const pad = document.createElement('div');
          pad.className = 'cal-day';
          gridDays.appendChild(pad);
        }

        const today = new Date(); today.setHours(0,0,0,0);
        for (let d=1; d<=daysInMonth; d++){
          const cur = new Date(y, m, d);
          const cell = document.createElement('div');
          cell.className = 'cal-day';

          const gSpan = document.createElement('div'); gSpan.className = 'g'; gSpan.textContent = d;
          const [hm, hd] = hPair(cur);
          const hSpan = document.createElement('div'); hSpan.className = 'h'; hSpan.textContent = hd + ' هـ';

          cell.appendChild(gSpan); cell.appendChild(hSpan);

          const cur0 = new Date(cur); cur0.setHours(0,0,0,0);
          if (+cur0 === +today) cell.classList.add('today');

          const reason = isSaudiHoliday(cur);
          if (reason){
            cell.classList.add('holiday');
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.textContent = reason;
            cell.appendChild(tag);
          }

          gridDays.appendChild(cell);
        }
      }

      btnPrev.addEventListener('click', ()=>{ view.setMonth(view.getMonth()-1); render(); });
      btnNext.addEventListener('click', ()=>{ view.setMonth(view.getMonth()+1); render(); });
      btnToday.addEventListener('click', ()=>{ view = new Date(); render(); });

      render();
    }

    setupCalendar({ title:'calp-title', dow:'calp-dow', days:'calp-days', prev:'calp-prev', next:'calp-next', today:'calp-today' });
  </script>
</body>
</html>
