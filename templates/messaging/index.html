{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>المراسلات</title>
<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --line2:#eef2f7;
    --chip:#f1f5f9; --card:#ffffff; --bg:transparent;
    --g1:#06b6d4; --g2:#4f46e5; --shadow:0 10px 28px rgba(2,6,23,.08);
  }
  body{margin:0;font-family:system-ui,Tajawal,Arial;background:var(--bg);color:var(--ink)}
  /* كل تنسيق محصور داخل .ms-root حتى لا يؤثر على الهيدر */
  .ms-root *{box-sizing:border-box}

  .ms-root .wrap{max-width:1100px;margin:auto;padding:20px 14px}

  /* تبويبات الصفحة */
  .ms-root .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  .ms-root .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;text-decoration:none;color:#111827}
  .ms-root .tab.active{background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;border-color:transparent}

  /* شبكة مربعات كل مستخدم */
  .ms-root .frames{display:grid;gap:16px}
  @media (min-width:920px){.ms-root .frames{grid-template-columns:repeat(2,minmax(0,1fr))}}

  .ms-root .box{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
  .ms-root .box-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:linear-gradient(90deg,#eef2ff,#f8fafc);border-bottom:1px solid var(--line)}
  .ms-root .who{display:flex;align-items:center;gap:10px}
  .ms-root .avatar{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:1000;background:linear-gradient(135deg,var(--g1),var(--g2));box-shadow:0 6px 16px rgba(79,70,229,.18)}
  .ms-root .name{font-weight:1000}
  .ms-root .badges{display:flex;gap:8px;flex-wrap:wrap}
  .ms-root .chip{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--line);font-size:12px;font-weight:900;color:#334155}

  .ms-root .list{display:grid;gap:10px;padding:12px}
  .ms-root .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line2);border-radius:12px;background:#fff}
  .ms-root .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .ms-root .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .ms-root .link{font-weight:900;color:#1d4ed8;text-decoration:none}
  .ms-root .mark{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;color:#fff}
  .ms-root .m-new{background:linear-gradient(90deg,#ef4444,#f97316)}
  .ms-root .m-unread{background:linear-gradient(90deg,#16a34a,#22c55e)}
  @media(max-width:560px){.ms-root .row{align-items:flex-start}}
</style>
</head>
<body>
{% include 'header.html' %}
<div class="ms-root">
  <div class="wrap">

    <div class="tabs">
      <a class="tab {% if scope == 'all' %}active{% endif %}" href="{% url 'messaging:inbox' %}?scope=all">الكل ({{ counts.all }})</a>
      <a class="tab {% if scope == 'sent' %}active{% endif %}" href="{% url 'messaging:inbox' %}?scope=sent">مرسلة ({{ counts.sent }})</a>
      <a class="tab {% if scope == 'inbox' %}active{% endif %}" href="{% url 'messaging:inbox' %}?scope=inbox">واردة ({{ counts.inbox }})</a>
      <a class="tab" href="{% url 'messaging:new' %}">+ رسالة جديدة</a>
    </div>

    <!-- سيتم بناء مربعات المستخدمين هنا -->
    <div id="frames" class="frames" aria-live="polite"></div>

    <!-- عناصر خام (لا تُعرض) لاستخدامها في التجميع حسب المستخدم -->
    <ul id="raw" hidden>
      {% for t in items %}
        {% if is_manager %}
          {% with peer=t.recipient %}
            <li
              data-peer-id="{{ peer.id }}"
              data-peer-name="{{ peer.username|default:peer.get_full_name|default:peer.email }}"
              data-peer-initial="{{ peer.username|default:peer.get_full_name|default:'?'|first }}"
              data-thread-id="{{ t.id }}"
              data-thread-ref="{{ t.reference }}"
              data-thread-url="{% url 'messaging:detail' t.pk %}"
              data-thread-subject="{{ t.subject }}"
              data-thread-status="{{ t.get_status_display }}"
              data-thread-created="{{ t.created_at|date:'Y/m/d H:i' }}"
              {% if t.last_message %}data-thread-last="{{ t.last_message.created_at|date:'Y/m/d H:i' }}"{% endif %}
              data-thread-new="{% if t.is_new_incoming %}1{% else %}0{% endif %}"
              data-thread-unread="{% if t.is_unread %}1{% else %}0{% endif %}"
            ></li>
          {% endwith %}
        {% elif t.sender_id == user.id %}
          {% with peer=t.recipient %}
            <li
              data-peer-id="{{ peer.id }}"
              data-peer-name="{{ peer.username|default:peer.get_full_name|default:peer.email }}"
              data-peer-initial="{{ peer.username|default:peer.get_full_name|default:'?'|first }}"
              data-thread-id="{{ t.id }}"
              data-thread-ref="{{ t.reference }}"
              data-thread-url="{% url 'messaging:detail' t.pk %}"
              data-thread-subject="{{ t.subject }}"
              data-thread-status="{{ t.get_status_display }}"
              data-thread-created="{{ t.created_at|date:'Y/m/d H:i' }}"
              {% if t.last_message %}data-thread-last="{{ t.last_message.created_at|date:'Y/m/d H:i' }}"{% endif %}
              data-thread-new="{% if t.is_new_incoming %}1{% else %}0{% endif %}"
              data-thread-unread="{% if t.is_unread %}1{% else %}0{% endif %}"
            ></li>
          {% endwith %}
        {% else %}
          {% with peer=t.sender %}
            <li
              data-peer-id="{{ peer.id }}"
              data-peer-name="{{ peer.username|default:peer.get_full_name|default:peer.email }}"
              data-peer-initial="{{ peer.username|default:peer.get_full_name|default:'?'|first }}"
              data-thread-id="{{ t.id }}"
              data-thread-ref="{{ t.reference }}"
              data-thread-url="{% url 'messaging:detail' t.pk %}"
              data-thread-subject="{{ t.subject }}"
              data-thread-status="{{ t.get_status_display }}"
              data-thread-created="{{ t.created_at|date:'Y/m/d H:i' }}"
              {% if t.last_message %}data-thread-last="{{ t.last_message.created_at|date:'Y/m/d H:i' }}"{% endif %}
              data-thread-new="{% if t.is_new_incoming %}1{% else %}0{% endif %}"
              data-thread-unread="{% if t.is_unread %}1{% else %}0{% endif %}"
            ></li>
          {% endwith %}
        {% endif %}
      {% empty %}
        <li data-empty="1"></li>
      {% endfor %}
    </ul>

  </div>
</div>
{% include 'footer.html' %}

<script>
/* تجميع المراسلات في مربعات لكل مستخدم (تصميم فقط) */
(function(){
  const raw = document.querySelectorAll('#raw li[data-peer-id]');
  const host = document.getElementById('frames');

  if (!raw.length){
    const empty = document.createElement('div');
    empty.style.padding='16px';
    empty.textContent='لا توجد مراسلات.';
    host.appendChild(empty);
    return;
  }

  const groups = {};
  raw.forEach(li=>{
    const pid = li.dataset.peerId;
    if(!groups[pid]){
      groups[pid] = {
        id: pid,
        name: li.dataset.peerName || 'مستخدم',
        initial: (li.dataset.peerInitial || '؟').slice(0,1),
        items: []
      };
    }
    groups[pid].items.push({...li.dataset});
  });

  Object.values(groups).forEach(g=>{
    const box = document.createElement('section'); box.className='box';

    const head = document.createElement('div'); head.className='box-head';
    const who = document.createElement('div'); who.className='who';
    const av = document.createElement('div'); av.className='avatar'; av.textContent = g.initial.toUpperCase();
    const nm = document.createElement('div'); nm.className='name'; nm.textContent = g.name;
    who.appendChild(av); who.appendChild(nm);

    const badges = document.createElement('div'); badges.className='badges';
    const total = document.createElement('span'); total.className='chip'; total.textContent=`إجمالي: ${g.items.length}`;
    const newCount = g.items.filter(x=>x.threadNew==='1' || x.threadUnread==='1').length;
    badges.appendChild(total);
    if(newCount>0){
      const nw = document.createElement('span'); nw.className='chip';
      nw.style.background='linear-gradient(90deg,#ef4444,#f97316)'; nw.style.color='#fff'; nw.style.border='0';
      nw.textContent=`جديد: ${newCount}`;
      badges.appendChild(nw);
    }
    head.appendChild(who); head.appendChild(badges);

    const list = document.createElement('div'); list.className='list';
    g.items
      .sort((a,b)=> (b.threadLast||'').localeCompare(a.threadLast||'')) 
      .forEach(d=>{
        const row = document.createElement('div'); row.className='row';

        const left = document.createElement('div'); left.className='left';
        const subj = document.createElement('span'); subj.textContent = `الموضوع: ${d.threadSubject||'—'}`;
        const ref = document.createElement('a'); ref.className='link'; ref.href=d.threadUrl; ref.textContent = d.threadRef ? d.threadRef : `#${d.threadId}`;
        left.appendChild(subj); left.appendChild(ref);

        const right = document.createElement('div'); right.className='right';
        const st = document.createElement('span'); st.className='chip'; st.textContent=`الحالة: ${d.threadStatus}`;
        const tm = document.createElement('span'); tm.className='chip'; tm.textContent = d.threadLast ? `آخر رد: ${d.threadLast}` : `أُنشئت: ${d.threadCreated}`;
        right.appendChild(st); right.appendChild(tm);

        if(d.threadNew==='1'){ const mk=document.createElement('span'); mk.className='mark m-new'; mk.textContent='جديدة'; right.appendChild(mk); }
        else if(d.threadUnread==='1'){ const mk=document.createElement('span'); mk.className='mark m-unread'; mk.textContent='واردة'; right.appendChild(mk); }

        row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      });

    box.appendChild(head); box.appendChild(list);
    host.appendChild(box);
  });
})();
</script>
</body>
</html>
