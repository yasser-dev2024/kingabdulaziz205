{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ t.subject }}</title>
  <style>
    :root{--brand:#1f3c88;--brand2:#2ebfa5;--accent:#ffb703;--txt:#0f172a;--bg:#f8fafc}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Tajawal,Arial;color:var(--txt);
         cursor:url("{% static 'maus.png' %}") 12 12, auto}
    a,button,.btn{cursor:inherit}
    .wrap{max-width:900px;margin:auto;padding:18px 16px}
    .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:16px}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .muted{color:#64748b}
    .msg{border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px;margin:8px 0;background:#fcfcfc}
    .from{font-weight:800}
    .files{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .pill{border:1px dashed rgba(0,0,0,.18);padding:6px 10px;border-radius:999px;font-size:12px;background:#fff}
    .row{display:grid;gap:6px}
    textarea{min-height:120px;padding:12px;border:1px solid rgba(0,0,0,.16);border-radius:12px;background:#fff;resize:vertical}
    input[type=file]{padding:12px;border:1px solid rgba(0,0,0,.16);border-radius:12px;background:#fff}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 14px;font-weight:800}
    .btn-primary{background:linear-gradient(100deg,var(--brand) 0%, color-mix(in srgb,var(--brand2) 70%, var(--brand) 30%) 100%);color:#fff}
    .btn-outline{background:#fff;border:1px solid rgba(0,0,0,.12)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  {% include 'header.html' %}
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div>
          <div><strong>{{ t.subject }}</strong></div>
          <div class="muted">مرجع: {{ t.reference }} • الحالة: {{ t.get_status_display }} • {{ t.created_at|date:"Y-m-d H:i" }}</div>
          <div class="muted">من: {{ t.sender.username }} • إلى: {{ t.recipient.username }}</div>
        </div>
        {% if t.status != "CLOSED" %}
        <form method="post" action="{% url 'messaging:close' t.pk %}">
          {% csrf_token %}
          <button class="btn btn-outline" type="submit">إغلاق المراسلة</button>
        </form>
        {% endif %}
      </div>

      {% for m in msgs %}
        <div class="msg">
          <div class="from">{{ m.author.username }}</div>
          <div class="muted" style="font-size:12px">{{ m.created_at|date:"Y-m-d H:i" }}</div>
          <div style="margin-top:6px;white-space:pre-wrap">{{ m.content }}</div>
          {% if m.files.all %}
            <div class="files">
              {% for f in m.files.all %}
                <a class="pill" href="{{ f.file.url }}" target="_blank" rel="noopener">مرفق {{ forloop.counter }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="muted">لا رسائل بعد.</div>
      {% endfor %}

      {% if t.status != "CLOSED" %}
      <form method="post" action="{% url 'messaging:reply' t.pk %}" enctype="multipart/form-data" style="margin-top:12px">
        {% csrf_token %}
        <div class="row">
          <label for="content">ردك</label>
          <textarea id="content" name="content"></textarea>
        </div>
        <div class="row">
          <label for="attachments">مرفقات (اختياري)</label>
          <input id="attachments" name="attachments" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit">إرسال الرد</button>
          <a class="btn btn-outline" href="{% url 'messaging:inbox' %}">العودة للصندوق</a>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
  {% include 'footer.html' %}
</body>
</html>
