{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>الإحالات</title>
<style>
  :root{
    --line:#e5e7eb; --ink:#0f172a; --muted:#64748b;
    --gradA:#06b6d4; --gradB:#4f46e5;
    --okA:#16a34a; --okB:#22c55e;
    --newA:#ef4444; --newB:#f87171;
  }
  body{margin:0;font-family:system-ui,Tajawal,Arial;background:#f6f8fb;color:var(--ink)}
  .wrap{max-width:1100px;margin:auto;padding:20px 14px}

  /* Tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:800;text-decoration:none;color:#111827}
  .tab.active{background:linear-gradient(90deg,var(--gradA),var(--gradB));color:#fff;border-color:transparent}

  /* “ملف الطالب” Folder Card */
  .folder{
    position:relative;
    background:linear-gradient(180deg,#ffffff,#fafbff);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 10px 28px rgba(2,6,23,.07);
    overflow:hidden;
    padding-top:26px;                 /* space for the tab */
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .folder:hover{transform:translateY(-1px); box-shadow:0 16px 36px rgba(2,6,23,.10)}

  .folder-tab{
    position:absolute; inset:0 auto auto 0;
    height:28px; width:160px; border-bottom:1px solid var(--line);
    border-right:1px solid var(--line);
    border-radius:12px 12px 0 0;
    background:linear-gradient(90deg,#eef2ff,#f8fafc);
    display:flex; align-items:center; gap:8px; padding:0 12px; font-weight:900; color:#1f2937;
  }
  .folder-tab .dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(90deg,var(--gradA),var(--gradB))}
  .folder-head{
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:10px 14px 8px 14px;
  }
  .folder-title{font-size:16px;font-weight:1000}
  .btn{appearance:none;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;padding:8px 12px;font-weight:800;text-decoration:none}
  .btn:focus{outline:2px solid #93c5fd;outline-offset:2px}

  /* Referral items inside folder */
  .list{display:grid;gap:10px;padding:12px}
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:12px;border:1px solid #eef2f7;border-radius:12px;background:#fff
  }
  .meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900}
  .b-type{background:#eef2ff;color:#1f2937;border:1px solid var(--line)}
  .b-new{background:linear-gradient(90deg,var(--newA),var(--newB));color:#fff;border:0}
  .b-read{background:linear-gradient(90deg,var(--okA),var(--okB));color:#fff;border:0}
  .chip{padding:6px 10px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line)}
  .ref-link{font-weight:900;color:#1d4ed8;text-decoration:none}

  /* Grid of folders */
  .folders{display:grid;gap:14px}
  @media(min-width:760px){ .folders{grid-template-columns:repeat(2, minmax(0,1fr))} }
  @media(min-width:1040px){ .folders{grid-template-columns:repeat(2, minmax(0,1fr))} }

  /* Small tweaks */
  .sep{height:1px;background:#eef2f7;margin:4px 0 0}
</style>
</head>
<body>
{% include 'header.html' %}
<div class="wrap">

  <div class="tabs">
    <a class="tab {% if scope == 'all' %}active{% endif %}" href="{% url 'referrals:index' %}?scope=all">الكل ({{ counts.all }})</a>
    <a class="tab {% if scope == 'sent' %}active{% endif %}" href="{% url 'referrals:index' %}?scope=sent">مرسلة ({{ counts.sent }})</a>
    <a class="tab {% if scope == 'inbox' %}active{% endif %}" href="{% url 'referrals:index' %}?scope=inbox">واردة ({{ counts.inbox }})</a>
    <a class="tab" href="{% url 'referrals:new' %}">+ إحالة جديدة</a>
  </div>

  <div class="folders">
    {% for g in groups %}
      <section class="folder" aria-label="ملف الطالب">
        <div class="folder-tab"><span class="dot" aria-hidden="true"></span> ملف الطالب</div>
        <div class="folder-head">
          <div class="folder-title">{{ g.student_name }}</div>
          {% if g.key %}
            <a class="btn" href="{% url 'referrals:student_file' g.key %}">فتح الملف</a>
          {% endif %}
        </div>
        <div class="sep"></div>

        <div class="list">
          {% for r in g.referrals %}
            <div class="item">
              <div class="meta">
                <a class="ref-link" href="{% url 'referrals:detail' r.pk %}">#{{ r.reference }}</a>
                <span class="badge b-type">{{ r.get_referral_type_display }}</span>
                {% if r.is_new_flag %}
                  <span class="badge b-new">جديدة • لم تُقرأ</span>
                {% elif r.is_read_flag %}
                  <span class="badge b-read">مقروءة • تم الرد</span>
                {% endif %}
              </div>
              <div class="meta">
                <span class="chip">أنشئت: {{ r.created_at|date:"Y/m/d H:i" }}</span>
                <span class="chip">الحالة: {{ r.get_status_display }}</span>
                {% if r.assignee %}<span class="chip">المكلّف: {{ r.assignee.username }}</span>{% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% empty %}
      <div style="padding:18px">لا توجد إحالات.</div>
    {% endfor %}
  </div>

</div>
{% include 'footer.html' %}
</body>
</html>
