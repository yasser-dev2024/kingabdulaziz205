<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تفاصيل الإحالة #{{ r.pk }}</title>
  <style>
    .rf-container{max-width:1200px;margin:24px auto;padding:0 12px}
    .rf-topbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
    .rf-section{margin-top:16px}
    .rf-grid{display:grid;gap:12px}
    .rf-grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:900px){.rf-grid-2{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .stack>*+*{margin-top:10px}
    .btn{display:inline-block;padding:9px 14px;border-radius:10px;border:0;background:#eef2ff;color:#111;text-decoration:none;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-danger{background:#ef4444;color:#fff}
    .badge{background:#eef2ff;color:#1f2937;border-radius:999px;padding:4px 10px;font-size:12px}
    .muted{color:#6b7280}
    .title{display:flex;align-items:center;gap:8px;margin:0 0 8px 0}
    .hr{height:1px;background:#e5e7eb;margin:10px 0}
    .file{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border:1px dashed #e5e7eb;border-radius:10px}
    .thread{display:flex;flex-direction:column;gap:10px}
    .note{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fafafa}
  </style>
</head>
<body>
<div class="rf-container">

  <!-- أزرار رجوع/الرئيسية -->
  <div class="rf-topbar">
    <button type="button" class="btn" onclick="history.back()">↩ رجوع</button>
    <a class="btn" href="/referrals/">الرئيسية ←</a>
  </div>

  <!-- رأس الصفحة -->
  <div class="card">
    <h2 class="title">
      <span class="badge">#{{ r.pk }}</span>
      <span>تفاصيل الإحالة</span>
    </h2>
    <div class="rf-grid rf-grid-2">
      <div class="stack">
        <div><strong>اسم الطالب:</strong> {{ r.student_name }}</div>
        <div><strong>الصف:</strong> {{ r.get_grade_display|default:r.grade }}</div>
        <div><strong>النوع:</strong> {{ r.get_referral_type_display|default:r.referral_type }}</div>
      </div>
      <div class="stack">
        <div><strong>الحالة:</strong> {{ r.get_status_display|default:r.status }}</div>
        <div><strong>منشأ بواسطة:</strong> {{ r.created_by.username }}</div>
        <div><strong>المكلّف الحالي:</strong> {{ r.assignee.username|default:"—" }}</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="muted">{{ r.details }}</div>
  </div>

  <!-- إجراءات سريعة + المرفقات -->
  <div class="rf-grid rf-grid-2 rf-section">

    <!-- إجراءات سريعة -->
    <div class="card stack">
      <h3>إجراءات سريعة</h3>

      {% if HAS_COUNSELOR and is_counselor %}
        <a class="btn btn-primary" href="{% url 'referrals:counselor' r.pk %}">نموذج بيانات الموجّه</a>
      {% endif %}

      <form action="{% url 'referrals:assign' r.pk %}" method="post" class="stack" aria-label="تحويل الإحالة">
        {% csrf_token %}
        <label for="assignee">تحويل إلى مستخدم</label>
        <select id="assignee" name="assignee" required>
          {% for u in assignable %}
            <option value="{{ u.id }}">{{ u.profile.full_name|default:u.username }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">تحويل</button>
      </form>

      <form action="{% url 'referrals:close' r.pk %}" method="post" onsubmit="return confirm('تأكيد إغلاق الإحالة؟');">
        {% csrf_token %}
        <button class="btn btn-danger" type="submit">إغلاق الإحالة</button>
      </form>
    </div>

    <!-- المرفقات -->
    <div class="card stack">
      <h3>المرفقات</h3>
      {% if files %}
        <div class="stack">
          {% for f in files %}
            <div class="file">
              <span>{{ f.filename|default:f.file.name }}</span>
              <a class="btn" href="{{ f.file.url }}" target="_blank" rel="noopener">عرض</a>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">لا توجد مرفقات.</div>
      {% endif %}
    </div>
  </div>

  <!-- ملخص بيانات الموجّه (يظهر للمخولّين) -->
  {% if can_view_counselor_summary and counselor_summary %}
    <section id="counselor-summary" class="rf-section">
      {% include "referrals/_counselor_summary.html" with groups=counselor_summary %}
    </section>
  {% endif %}

  <!-- سوابق لنفس الطالب -->
  {% if same_student %}
    <div class="card rf-section">
      <h3>إحالات أخرى لنفس الطالب</h3>
      <ul>
        {% for x in same_student %}
          <li><a href="{% url 'referrals:detail' x.pk %}">إحالة #{{ x.pk }}</a> – <span class="muted">{{ x.created_at|date:"Y-m-d H:i" }}</span></li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- السجل -->
  <div class="card rf-section">
    <h3>السجل</h3>
    <div class="thread">
      {% for a in actions %}
        <div class="note">
          <div class="muted">{{ a.created_at|date:"Y-m-d H:i" }} • {{ a.author.username }} • {{ a.get_kind_display|default:a.kind }}</div>
          <div>{{ a.content|linebreaksbr }}</div>
          {% if a.files.all %}
            <div class="hr"></div>
            <div class="stack">
              {% for af in a.files.all %}
                <div class="file">
                  <span>{{ af.filename|default:af.file.name }}</span>
                  <a class="btn" href="{{ af.file.url }}" target="_blank" rel="noopener">عرض</a>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="muted">لا يوجد سجل بعد.</div>
      {% endfor %}
    </div>
  </div>

  <!-- إرسال رد -->
  <div class="card rf-section">
    <h3>إرسال رد</h3>
    <form action="{% url 'referrals:reply' r.pk %}" method="post" enctype="multipart/form-data" class="stack">
      {% csrf_token %}
      <label for="content">النص</label>
      <textarea id="content" name="content" placeholder="اكتب ردك هنا..."></textarea>

      <label for="reply_files">مرفقات (اختياري)</label>
      <input id="reply_files" type="file" name="reply_files" multiple>

      <button class="btn btn-primary" type="submit">إرسال</button>
    </form>
  </div>

</div>
</body>
</html>
