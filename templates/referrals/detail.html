{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تفاصيل الإحالة</title>
  <style>
    :root{--txt:#0f172a;--bg:#f8fafc}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Tajawal,Arial;color:var(--txt)}
    .wrap{max-width:1100px;margin:auto;padding:18px 16px}
    .card{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:18px;padding:16px}
    .row{margin:6px 0}
    select,input,textarea,button{padding:10px;border:1px solid rgba(0,0,0,.16);border-radius:12px;background:#fff}
    textarea{min-height:110px;resize:vertical}
    .btn{cursor:pointer}
    .stack{display:grid;gap:8px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr; }
    @media(min-width:900px){ .grid2{grid-template-columns:1fr 1fr;} }
    .muted{color:#64748b;font-size:13px}
  </style>
</head>
<body>
  {% include 'header.html' %}
  <div class="wrap">
    <div class="card">
      <h2>تفاصيل الإحالة</h2>

      <div class="row"><b>الطالب:</b> {{ r.student_name }} — <b>الصف:</b> {{ r.get_grade_display }}</div>
      <div class="row"><b>النوع:</b> {{ r.get_referral_type_display }}</div>
      <div class="row"><b>الوصف:</b> {{ r.details }}</div>

      <div class="row">
        <b>المنشئ:</b>
        {{ r.created_by.profile.full_name|default:r.created_by.username }}
        •
        <b>المكلّف الحالي:</b>
        {% if r.assignee %}
          {{ r.assignee.profile.full_name|default:r.assignee.username }}
        {% else %}
          —
        {% endif %}
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card stack">
        <h3>إجراءات سريعة</h3>

        <form action="{% url 'referrals:assign' r.pk %}" method="post" class="stack">
          {% csrf_token %}
          <label for="assignee">تحويل إلى مستخدم</label>
          <select id="assignee" name="assignee" required>
            {% for u in assignable %}
              <option value="{{ u.id }}">{{ u.profile.full_name|default:u.username }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit">تحويل</button>
        </form>

        <form action="{% url 'referrals:close' r.pk %}" method="post">
          {% csrf_token %}
          <button class="btn" type="submit">إغلاق الإحالة</button>
        </form>
      </div>

      <div class="card stack">
        <h3>إرسال رد</h3>
        <form action="{% url 'referrals:reply' r.pk %}" method="post" enctype="multipart/form-data" class="stack">
          {% csrf_token %}
          <label for="content">النص</label>
          <textarea id="content" name="content" placeholder="اكتب ردك هنا…"></textarea>

          <label for="reply_files">مرفقات (اختياري)</label>
          <input id="reply_files" name="reply_files" type="file" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
          <div class="muted">حتى 5 ملفات وبحجم 10MB للملف الواحد.</div>

          <button class="btn" type="submit">إرسال الرد</button>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>المرفقات</h3>
      {% for f in files %}
        <div class="row"><a href="{{ f.file.url }}" target="_blank">ملف</a> — {{ f.uploaded_at|date:"Y-m-d H:i" }}</div>
      {% empty %}
        <div class="row">لا توجد مرفقات.</div>
      {% endfor %}
    </div>

    <div class="card" style="margin-top:12px">
      <h3>الردود</h3>
      {% for act in actions %}
        <div class="row">
          <b>{{ act.author.profile.full_name|default:act.author.username }}</b> — {{ act.created_at|date:"Y-m-d H:i" }}<br>
          {{ act.content|default:"(بدون نص)" }}
        </div>
      {% empty %}
        <div class="row">لا توجد ردود بعد.</div>
      {% endfor %}
    </div>
  </div>
  {% include 'footer.html' %}
</body>
</html>
