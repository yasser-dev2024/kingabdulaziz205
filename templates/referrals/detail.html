{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>تفاصيل إحالة #{{ r.reference }}</title>
<style>
  body{margin:0;font-family:system-ui,Tajawal,Arial;background:#f7fafc;color:#0f172a}
  .wrap{max-width:1100px;margin:auto;padding:20px 14px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(2,6,23,.07);overflow:hidden}
  .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:linear-gradient(90deg,#06b6d4,#4f46e5);color:#fff}
  .sec{padding:14px 16px;border-top:1px solid #eef2f7}
  .badge{padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #e5e7eb;color:#1f2937;font-weight:900}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #e5e7eb;border-radius:10px;background:#111827;color:#fff;padding:8px 12px;font-weight:800;text-decoration:none}
  .btn-outline{background:#fff;color:#111827}
  .green{background:#16a34a}
  .red{background:#dc2626}
  .tag-new{background:#fee2e2;color:#991b1b;border-color:#fecaca}
  .tag-read{background:#dcfce7;color:#166534;border-color:#bbf7d0}
</style>
</head>
<body>
{% include 'header.html' %}
<div class="wrap">
  <div class="card">
    <div class="head">
      <div>إحالة #{{ r.reference }} — {{ r.student_name }}</div>
      <div class="row">
        <a class="btn btn-outline" href="{% url 'referrals:index' %}">رجوع</a>
        {% if r.is_new_flag %}<span class="badge tag-new">جديدة</span>{% elif r.is_read_flag %}<span class="badge tag-read">مقروءة</span>{% endif %}
        {% comment %} زر نموذج بيانات الموجّه يظهر فقط للموجّه الطلابي {% endcomment %}
        {% if HAS_COUNSELOR and is_counselor %}
          <a class="btn" href="{% url 'referrals:counselor' r.pk %}">نموذج بيانات الموجّه</a>
        {% endif %}
      </div>
    </div>

    <div class="sec">
      <div class="row">
        <span class="badge">النوع: {{ r.get_referral_type_display }}</span>
        <span class="badge">الحالة: {{ r.get_status_display }}</span>
        {% if r.assignee %}<span class="badge">المكلّف: {{ r.assignee.username }}</span>{% endif %}
        <span class="badge">أُنشئت: {{ r.created_at|date:"Y/m/d H:i" }}</span>
      </div>
    </div>

    {% if files %}
    <div class="sec">
      <div style="font-weight:900;margin-bottom:6px">مرفقات الإحالة</div>
      <div class="row">
        {% for f in files %}
          <a class="btn btn-outline" href="{{ f.file.url }}" target="_blank" rel="noopener">ملف #{{ forloop.counter }}</a>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="sec">
      <div style="font-weight:1000;margin-bottom:8px">الإجراءات</div>
      {% for a in actions %}
        <div style="padding:10px;border:1px solid #eef2f7;border-radius:10px;margin-bottom:8px">
          <div class="row" style="justify-content:space-between">
            <div><strong>{{ a.get_kind_display }}</strong> — {{ a.author.username }}</div>
            <div>{{ a.created_at|date:"Y/m/d H:i" }}</div>
          </div>
          {% if a.content %}<div style="margin-top:6px">{{ a.content }}</div>{% endif %}
          {% if a.files.all %}
            <div class="row" style="margin-top:8px">
              {% for f in a.files.all %}
                <a class="btn btn-outline" href="{{ f.file.url }}" target="_blank" rel="noopener">مرفق #{{ forloop.counter }}</a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% empty %}
        لا توجد إجراءات.
      {% endfor %}
    </div>

    <div class="sec">
      <form method="post" action="{% url 'referrals:reply' r.pk %}" enctype="multipart/form-data">{% csrf_token %}
        <div style="font-weight:900;margin-bottom:6px">إضافة رد</div>
        <textarea name="content" style="width:100%;min-height:100px;border:1px solid #e5e7eb;border-radius:10px;padding:10px"></textarea>
        <div style="margin-top:8px"><input type="file" name="reply_files" multiple></div>
        <div class="row" style="margin-top:10px">
          <button class="btn green" type="submit">إرسال الرد</button>
          {% if r.status != 'CLOSED' %}
          <form method="post" action="{% url 'referrals:close' r.pk %}">{% csrf_token %}
            <button class="btn red" type="submit">إغلاق الإحالة</button>
          </form>
          {% endif %}
        </div>
      </form>
    </div>

    {% if HAS_COUNSELOR and can_view_counselor_summary and counselor_summary %}
    <div class="sec">
      {% include 'referrals/_counselor_summary.html' with sections=counselor_summary only %}
    </div>
    {% endif %}
  </div>
</div>
{% include 'footer.html' %}
</body>
</html>
